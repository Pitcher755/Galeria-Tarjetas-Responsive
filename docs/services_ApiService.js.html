<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/ApiService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/ApiService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { AppConfig } from '../config/AppConfig.js';
import { AppState } from '../state/AppState.js';
import { Logger } from '../utils/Logger.js';

/**
 * @file ApiService.js
 * @description Servicio para manejar todas las comunicaciones con el backend, incluyendo mocks.
 */

/**
 * @constant
 * @type {Object}
 */
const ApiConfig = {
    baseURL: 'https://api.tutienda.com/v1',
    timeout: 10000,
    endpoints: {
        products: '/products',
        categories: '/categories',
        search: '/products/search',
        filters: '/products/filters'
    },
    headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    }
};

/**
 * @constant
 * @type {Object}
 * @property {boolean} enabled - Si el mock está habilitado (debe ser true en dev local)
 * @property {number} delay - Simulación de latencia de red (ms)
 * @property {number} failRate - Porcentaje de fallos simulados
 */
export const MockConfig = { // Exportamos MockConfig
    enabled: true,
    delay: 300,
    failRate: 0.1
};

/**
 * @constant
 * @type {Object}
 */
export const ApiService = {

    /**
     * @async
     * @function request
     * @description Realiza una petición HTTP, usando mock si está habilitado.
     * @param {string} url - URL del endpoint
     * @param {Object} [options={}] - Opciones de fetch
     * @returns {Promise&lt;Object>} Respuesta de la API
     */
    async request(url, options = {}) {
        const startTime = Date.now();
        try {
            // Cuando MockConfig.enabled es TRUE, no queremos intentar acceder a la URL real
            // Sin embargo, esta función está diseñada para manejar peticiones de prod.

            // Si la URL NO incluye 'http' (es decir, es un endpoint interno de Mock), la tratamos como mock.
            // NOTA: Como 'ProductService.js' ahora decide si usar la API o no, 
            // dejaremos esta lógica interna de 'request' intacta para URLs que no sean http,
            // pero el ProductService evitará llamarla con URLs de prod si MockConfig.enabled es true.
            if (MockConfig.enabled &amp;&amp; !url.includes('http')) {
                return await this.mockRequest(url, options);
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), ApiConfig.timeout);

            const response = await fetch(url, {
                ...options,
                headers: { ...ApiConfig.headers, ...options.headers },
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            const duration = Date.now() - startTime;
            Logger.info(`🌐 API Request: ${url} (${duration}ms)`);

            return data;
        } catch (error) {
            Logger.error(`❌ API Error: ${url}`, error);
            throw this.handleError(error);
        }
    },

    /**
     * @async
     * @function mockRequest
     * @description Simula una petición a la API.
     * @param {string} endpoint - Endpoint a simular
     * @param {Object} [options={}] - Opciones de la petición
     * @returns {Promise&lt;Object>} Datos mock
     */
    async mockRequest(endpoint, options = {}) {
        await new Promise(resolve => setTimeout(resolve, MockConfig.delay));

        if (Math.random() &lt; MockConfig.failRate) {
            throw new Error('Mock API Error: Simulated network failure');
        }

        const method = options.method || 'GET';
        Logger.info(`🎭 Mock API: ${method} ${endpoint}`);

        switch (endpoint) {
            case ApiConfig.endpoints.products:
                return this.getMockProducts();
            case ApiConfig.endpoints.categories:
                return this.getMockCategories();
            case ApiConfig.endpoints.search:
                return this.getMockSearch(options.body);
            case ApiConfig.endpoints.filters:
                return this.getMockFilters();
            default:
                throw new Error(`Mock endpoint not found: ${endpoint}`);
        }
    },

    /**
     * @async
     * @function getProducts
     * @description Construye la URL de productos para la API real.
     * @param {Object} [params={}] - Parámetros de filtrado
     * @returns {Promise&lt;Object>} Lista de productos
     */
    async getProducts(params = {}) {
        const queryString = new URLSearchParams(params).toString();
        const url = `${ApiConfig.baseURL}${ApiConfig.endpoints.products}?${queryString}`;
        return await this.request(url);
    },

    /**
     * @async
     * @function getCategories
     * @description Construye la URL de categorías para la API real.
     * @returns {Promise&lt;Object>} Lista de categorías
     */
    async getCategories() {
        const url = `${ApiConfig.baseURL}${ApiConfig.endpoints.categories}`;
        return await this.request(url);
    },

    /**
     * @async
     * @function searchProducts
     * @description Busca productos en la API real.
     * @param {string} query - Término de búsqueda
     * @param {Object} [filters={}] - Filtros adicionales
     * @returns {Promise&lt;Object>} Productos encontrados
     */
    async searchProducts(query, filters = {}) {
        const url = `${ApiConfig.baseURL}${ApiConfig.endpoints.search}`;
        return await this.request(url, {
            method: 'POST',
            body: JSON.stringify({ query, filters })
        });
    },

    /**
     * @async
     * @function getFilterOptions
     * @description Obtiene opciones de filtrado.
     * @returns {Promise&lt;Object>} Opciones de filtrado disponibles
     */
    async getFilterOptions() {
        const url = `${ApiConfig.baseURL}${ApiConfig.endpoints.filters}`;
        return await this.request(url);
    },

    /**
     * @function handleError
     * @description Formatea errores de fetch y timeout.
     * @param {Error} error - Error original
     * @returns {Error} Error formateado
     */
    handleError(error) {
        if (error.name === 'AbortError') {
            return new Error('Request timeout: La conexión tardó demasiado tiempo');
        }
        if (error.message.includes('Failed to fetch')) {
            return new Error('Error de conexión: Verifica tu conexión a internet');
        }
        return error;
    },

    /**
     * @function getMockProducts
     * @description Retorna datos mock de productos.
     * @returns {Object} Datos mock
     */
    getMockProducts() {
        return {
            success: true,
            data: AppState.products,
            pagination: {
                total: AppState.products.length,
                page: 1,
                pages: 1,
                limit: 50
            },
            timestamp: new Date().toISOString()
        };
    },

    /**
     * @function getMockCategories
     * @description Retorna datos mock de categorías.
     * @returns {Object} Datos mock
     */
    getMockCategories() {
        return {
            success: true,
            data: AppState.categories,
            timestamp: new Date().toISOString()
        };
    },

    /**
     * @function getMockSearch
     * @param {string} body - JSON string con la consulta
     * @returns {Object} Datos mock
     */
    getMockSearch(body) {
        const searchParams = JSON.parse(body || '{}');
        const query = searchParams.query?.toLowerCase() || '';
        const filteredProducts = AppState.products.filter(product =>
            product.title.toLowerCase().includes(query) ||
            product.description.toLowerCase().includes(query)
        );
        return {
            success: true,
            data: filteredProducts,
            query: searchParams.query,
            total: filteredProducts.length,
            timestamp: new Date().toISOString()
        };
    },

    /**
     * @function getMockFilters
     * @returns {Object} Datos mock
     */
    getMockFilters() {
        return {
            success: true,
            data: {
                status: AppConfig.filters.statusOptions,
                tags: AppConfig.filters.tagOptions,
                priceRanges: [
                    { min: 0, max: 50, label: 'Menos de €50' },
                    { min: 50, max: 100, label: '€50 - €100' },
                    { min: 100, max: 200, label: '€100 - €200' },
                    { min: 200, max: null, label: 'Más de €200' }
                ]
            },
            timestamp: new Date().toISOString()
        };
    }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="Logger.html">Logger</a></li><li><a href="PerformanceOptimizer.html">PerformanceOptimizer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ApiConfig">ApiConfig</a></li><li><a href="global.html#ApiService">ApiService</a></li><li><a href="global.html#AppConfig">AppConfig</a></li><li><a href="global.html#AppState">AppState</a></li><li><a href="global.html#FilterSystem">FilterSystem</a></li><li><a href="global.html#MockConfig">MockConfig</a></li><li><a href="global.html#addFilter">addFilter</a></li><li><a href="global.html#applyAllFilters">applyAllFilters</a></li><li><a href="global.html#applyAllFiltersAndRender">applyAllFiltersAndRender</a></li><li><a href="global.html#clearAllFilters">clearAllFilters</a></li><li><a href="global.html#createProductCard">createProductCard</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#error">error</a></li><li><a href="global.html#generateStarRating">generateStarRating</a></li><li><a href="global.html#getCategories">getCategories</a></li><li><a href="global.html#getCategoryIcon">getCategoryIcon</a></li><li><a href="global.html#getFilterOptions">getFilterOptions</a></li><li><a href="global.html#getFilterStats">getFilterStats</a></li><li><a href="global.html#getMockCategories">getMockCategories</a></li><li><a href="global.html#getMockFilters">getMockFilters</a></li><li><a href="global.html#getMockProducts">getMockProducts</a></li><li><a href="global.html#getMockSearch">getMockSearch</a></li><li><a href="global.html#getProducts">getProducts</a></li><li><a href="global.html#handleCategoryFilterClick">handleCategoryFilterClick</a></li><li><a href="global.html#handleCheckboxFilterChange">handleCheckboxFilterChange</a></li><li><a href="global.html#handleClearAllFilters">handleClearAllFilters</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#info">info</a></li><li><a href="global.html#initApp">initApp</a></li><li><a href="global.html#initLazyLoading">initLazyLoading</a></li><li><a href="global.html#initializeActiveFiltersDisplay">initializeActiveFiltersDisplay</a></li><li><a href="global.html#initializeCategoryFilters">initializeCategoryFilters</a></li><li><a href="global.html#initializeConnectionMonitor">initializeConnectionMonitor</a></li><li><a href="global.html#initializeFilters">initializeFilters</a></li><li><a href="global.html#initializeSearchFilter">initializeSearchFilter</a></li><li><a href="global.html#initializeStatusFilters">initializeStatusFilters</a></li><li><a href="global.html#loadFallbackData">loadFallbackData</a></li><li><a href="global.html#loadProductData">loadProductData</a></li><li><a href="global.html#matchesCategory">matchesCategory</a></li><li><a href="global.html#matchesSearch">matchesSearch</a></li><li><a href="global.html#matchesStatusFilters">matchesStatusFilters</a></li><li><a href="global.html#matchesStockFilter">matchesStockFilter</a></li><li><a href="global.html#matchesTagFilters">matchesTagFilters</a></li><li><a href="global.html#mockRequest">mockRequest</a></li><li><a href="global.html#preloadCriticalResources">preloadCriticalResources</a></li><li><a href="global.html#removeFilter">removeFilter</a></li><li><a href="global.html#renderAllProducts">renderAllProducts</a></li><li><a href="global.html#renderFilteredProducts">renderFilteredProducts</a></li><li><a href="global.html#request">request</a></li><li><a href="global.html#resetFilterUI">resetFilterUI</a></li><li><a href="global.html#searchProducts">searchProducts</a></li><li><a href="global.html#showErrorMessage">showErrorMessage</a></li><li><a href="global.html#showLoadingState">showLoadingState</a></li><li><a href="global.html#showSkeletonLoading">showSkeletonLoading</a></li><li><a href="global.html#throttledRender">throttledRender</a></li><li><a href="global.html#updateActiveFiltersDisplay">updateActiveFiltersDisplay</a></li><li><a href="global.html#updateCategoryFilterButtons">updateCategoryFilterButtons</a></li><li><a href="global.html#updateConnectionStatus">updateConnectionStatus</a></li><li><a href="global.html#updateFilterStats">updateFilterStats</a></li><li><a href="global.html#updateStatistics">updateStatistics</a></li><li><a href="global.html#validateDOMElements">validateDOMElements</a></li><li><a href="global.html#warn">warn</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Fri Oct 24 2025 00:36:51 GMT+0200 (hora de verano de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
